name: Sync M3U

on:
  schedule:
    - cron: '0 * * * *' # Corre cada hora
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repo
        uses: actions/checkout@v4

      - name: Preparar carpetas y bajar archivos
        run: |
          # 1. Creamos la carpeta de destino (si no existe)
          mkdir -p sync-m3u
          
          # 2. Buscamos las URLs en el repo de origen
          curl -s https://api.github.com/repos/abusaeeidx/IPTV-Scraper-Zilla/contents \
          | jq -r '.[] | select(.name | test("\\.(m3u8?)$")) | .download_url' > urls.txt
          
          echo "URLs encontradas:"
          cat urls.txt

          # 3. Bajamos los archivos DENTRO de la carpeta sync-m3u
          while read -r url; do
            [ -z "$url" ] && continue
            filename=$(basename "$url")
            echo "Bajando $filename..."
            curl -L -o "sync-m3u/$filename" "$url"
          done < urls.txt

      - name: Procesar Pluto World
        run: |
          # Chequeamos si se baj√≥ el archivo que nos interesa
          if [ -f "sync-m3u/PlutoTV-All.m3u" ]; then
            echo "Encontrado PlutoTV-All.m3u, procesando..."
            
            # 1. Lo movemos a la ra√≠z con el nombre nuevo
            mv "sync-m3u/PlutoTV-All.m3u" ./PlutoTV-World.m3u
            
            # 2. Capturamos la fecha y hora actual
          FECHA=$(date +"%Y-%m-%d %H:%M:%S")

          # 3. Creamos un archivo temporal solo con TU encabezado
          # Usamos $FECHA para que se actualice sola
          cat <<EOF > header_temp.txt
          #=================================
          # üñ• Developed by: v0ltax
          # üéØ This repository does NOT host any content.
          # üîó M3U8: https://github.com/abusaeeidx/IPTV-Scraper-Zilla
          # üîó EPG: https://github.com/matthuisman/i.mjh.nz
          # üïí Last Updated: $FECHA
          #==================================
          #EXTM3U url-tvg="https://raw.github.com/matthuisman/i.mjh.nz/master/PlutoTV/all.xml.gz"
          #==================================
          EOF
            
            # Unimos: Header + Contenido del archivo (quit√°ndole la 1ra l√≠nea original para no duplicar #EXTM3U)
            # Si el original NO tiene #EXTM3U, sacale el "tail -n +2" y dej√° solo "cat PlutoTV-World.m3u"
            cat header_temp.txt > PlutoTV-World.temp
            tail -n +2 PlutoTV-World.m3u >> PlutoTV-World.temp
            
            # Reemplazamos el archivo final
            mv PlutoTV-World.temp PlutoTV-World.m3u
            rm header_temp.txt
            
          else
            echo "Ojo: No se encontr√≥ PlutoTV-All.m3u en la descarga."
          fi

      - name: Commit y Push
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'

          # Agregamos la carpeta sync y el archivo de la ra√≠z
          git add sync-m3u/
          git add PlutoTV-World.m3u

          # Commiteamos si hay cambios
          git diff --cached --quiet || (git commit -m "Sync: Archivos m3u" && git push)
