name: 3. Process TVPass

on:
  schedule:
    - cron: '30 3 * * *' # 'minuto hora * * *' -> Todos los d√≠as a las 03:30 AM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process-file:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repo
        uses: actions/checkout@v4

      - name: Editar TVPass + header
        run: |
          # Chequeamos si el archivo existe (del workflow anterior)
          if [ -f "sync-m3u/TVPass.m3u" ]; then
            echo "Archivo encontrado. Procesando..."
            
            # 1. Moverlo a la ra√≠z con nombre nuevo
            # Usamos cp en vez de mv para dejar una copia en sync por las dudas, 
            # o mv si quer√©s sacarlo de ah√≠. Voy con cp para no romper la carpeta sync.
            cp "sync-m3u/TVPass.m3u" ./TVPassEpg.m3u
            
            # 2. Fecha actual
            FECHA=$(date +"%Y-%m-%d %H:%M:%S")

            # 3. Armar el Header
            cat <<EOF > header_temp.txt
          #=================================
          # üñ• Developed by: v0ltax
          # üéØ This repository does NOT host any content.
          # üîó M3U8: https://github.com/abusaeeidx/IPTV-Scraper-Zilla
          # üîó EPG: https://tvpass.org/
          # üïí Last Updated: $FECHA
          #==================================
          #EXTM3U url-tvg="https://tvpass.org/epg.xml"
          #==================================
          EOF

            # 4. Pegar Header + Contenido (borrando la 1ra l√≠nea del original)
            cat header_temp.txt > TVPassEpg.temp
            tail -n +2 TVPassEpg.m3u >> TVPassEpg.temp
            
            # 5. Reemplazar archivo final y limpiar
            mv TVPassEpg.temp TVPassEpg.m3u
            rm header_temp.txt
            
          else
            echo "‚ö†Ô∏è No se encontr√≥ sync-m3u/TVPass.m3u. Quiz√°s fall√≥ la descarga anterior."
            exit 0
          fi

      - name: Commit y Push
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action@github.com'
          
          # Agregamos el archivo de la ra√≠z
          git add TVPassEpg.m3u
          
          # Commit si cambi√≥ algo (ej: la fecha o canales nuevos)
          git diff --cached --quiet || (git commit -m "Update: TVPass m3u + epg" && git push)
